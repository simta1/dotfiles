#!/usr/bin/env python3
import subprocess
import sys

cons = {
    'r':'ㄱ', 'R':'ㄲ', 's':'ㄴ', 'e':'ㄷ', 'E':'ㄸ', 'f':'ㄹ',
    'a':'ㅁ', 'q':'ㅂ', 'Q':'ㅃ', 't':'ㅅ', 'T':'ㅆ',
    'd':'ㅇ', 'w':'ㅈ', 'W':'ㅉ', 'c':'ㅊ', 'z':'ㅋ',
    'x':'ㅌ', 'v':'ㅍ', 'g':'ㅎ',
}
vowels = {
    'k':'ㅏ', 'o':'ㅐ', 'i':'ㅑ', 'O':'ㅒ',
    'j':'ㅓ', 'p':'ㅔ', 'u':'ㅕ', 'P':'ㅖ',
    'h':'ㅗ', 'hk':'ㅘ', 'ho':'ㅙ', 'hl':'ㅚ',
    'y':'ㅛ', 'n':'ㅜ', 'nj':'ㅝ', 'np':'ㅞ', 'nl':'ㅟ',
    'b':'ㅠ', 'm':'ㅡ', 'ml':'ㅢ', 'l':'ㅣ',
}
cons_double = {
    'rt':'ㄳ', 'sw':'ㄵ', 'sg':'ㄶ',
    'fr':'ㄺ', 'fa':'ㄻ', 'fq':'ㄼ', 'ft':'ㄽ',
    'fx':'ㄾ', 'fv':'ㄿ', 'fg':'ㅀ',
    'qt':'ㅄ',
}

L_KEYS = ['r','R','s','e','E','f','a','q','Q','t','T','d','w','W','c','z','x','v','g']
V_KEYS = ['k','o','i','O','j','p','u','P','h','hk','ho','hl','y','n','nj','np','nl','b','m','ml','l']
T_KEYS = ['', 'r','R','rt','s','sw','sg','e','f','fr','fa','fq','ft','fx','fv','fg','a','q','qt','t','T','d','w','c','z','x','v','g']

CHOSUNG_LIST = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ']
JUNGSUNG_LIST = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ']
JONGSUNG_LIST = ['', 'ㄱ','ㄲ','ㄳ','ㄴ','ㄵ','ㄶ','ㄷ','ㄹ','ㄺ','ㄻ','ㄼ','ㄽ','ㄾ','ㄿ','ㅀ','ㅁ','ㅂ','ㅄ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ']

CHO_INDEX = {ch:i for i,ch in enumerate(CHOSUNG_LIST)}
JUNG_INDEX = {ch:i for i,ch in enumerate(JUNGSUNG_LIST)}
JONG_INDEX = {ch:i for i,ch in enumerate(JONGSUNG_LIST) if ch}

SBase = 0xAC00
LCount = 19
VCount = 21
TCount = 28
NCount = VCount * TCount
SCount = LCount * NCount

def eng2kor_jamo(text: str) -> str:
    result = []
    vc = []

    for ch in text:
        if ch in cons:
            vc.append('c')
        elif ch in vowels:
            vc.append('v')
        else:
            vc.append('!')

    vc = ''.join(vc)
    vc = vc.replace('cvv', 'fVV').replace('cv', 'fv').replace('cc', 'dd')

    i = 0
    n = len(text)
    while i < n:
        t = text[i]
        v = vc[i]
        step = 1
        try:
            if v in ('f', 'c'):
                result.append(cons[t])
            elif v == 'V':
                result.append(vowels[text[i:i+2]])
                step = 2
            elif v == 'v':
                result.append(vowels[t])
            elif v == 'd':
                result.append(cons_double[text[i:i+2]])
                step = 2
            else:
                result.append(t)
        except Exception:
            result.append(t)
        i += step

    return ''.join(result)

def compose_syllable(L, V, T):
    """호환 자모(L,V,T)로부터 완성형 한글 한 글자 생성."""
    if L is None or V is None:
        return (L or '') + (V or '') + (T or '')
    l = CHO_INDEX.get(L)
    v = JUNG_INDEX.get(V)
    t = 0
    if T:
        t = JONG_INDEX.get(T, 0)
    if l is None or v is None:
        return (L or '') + (V or '') + (T or '')
    sindex = l * NCount + v * TCount + t
    return chr(SBase + sindex)

def join_jamos_compat(text: str) -> str:
    """호환 자모 문자열을 완성형 한글로."""
    out = []
    L = V = T = None

    def flush():
        nonlocal L, V, T
        if L is not None or V is not None or T is not None:
            out.append(compose_syllable(L, V, T))
        L = V = T = None

    i = 0
    n = len(text)
    while i < n:
        ch = text[i]

        if ch in JUNG_INDEX:
            if L is None:
                flush()
                out.append(ch)
            else:
                if V is None:
                    V = ch
                else:
                    flush()
                    out.append(ch)
            i += 1
            continue

        if ch in CHO_INDEX or ch in JONG_INDEX:
            if V is None:
                if L is None:
                    L = ch
                else:
                    flush()
                    L = ch
                i += 1
                continue
            else:
                next_ch = text[i+1] if i+1 < n else None
                if T is None:
                    if next_ch is not None and next_ch in JUNG_INDEX:
                        flush()
                        L = ch
                        V = T = None
                    else:
                        T = ch
                    i += 1
                    continue
                else:
                    flush()
                    L = ch
                    i += 1
                    continue

        flush()
        out.append(ch)
        i += 1

    flush()
    return ''.join(out)

def eng2kor(text: str) -> str:
    return join_jamos_compat(eng2kor_jamo(text))

def kor2eng(text: str) -> str:
    out = []
    for ch in text:
        code = ord(ch)
        if 0xAC00 <= code <= 0xD7A3:
            sindex = code - SBase
            LIndex = sindex // NCount
            VIndex = (sindex % NCount) // TCount
            TIndex = sindex % TCount

            out.append(L_KEYS[LIndex])
            out.append(V_KEYS[VIndex])
            if TIndex != 0:
                out.append(T_KEYS[TIndex])
        else:
            out.append(ch)
    return ''.join(out)

def has_korean(text: str) -> bool:
    for ch in text:
        code = ord(ch)
        if (
            0xAC00 <= code <= 0xD7A3
            or 0x1100 <= code <= 0x11FF
            or 0x3130 <= code <= 0x318F
        ):
            return True
    return False

def main():
    types_proc = subprocess.run(
        ["wl-paste", "--list-types"],
        capture_output=True,
        text=True,
    )
    types = types_proc.stdout

    if "text/plain" not in types:
        subprocess.run([
            "notify-send",
            "한/영 변환 스킵됨",
            "텍스트가 아닙니다."
        ])
        return

    proc = subprocess.run(
        ["wl-paste"],
        capture_output=True,
        text=True,
    )
    if proc.returncode != 0:
        subprocess.run(["notify-send", "한/영 변환 에러", "wl-paste 실행 실패"])
        sys.exit(1)

    original = proc.stdout
    if not original:
        subprocess.run(["notify-send", "한/영 변환", "클립보드가 비어 있습니다."])
        return

    if has_korean(original):
        direction = "한 → 영"
        converted_lines = [kor2eng(line) for line in original.splitlines()]
    else:
        direction = "영 → 한"
        converted_lines = [eng2kor(line) for line in original.splitlines()]

    converted = "\n".join(converted_lines)

    subprocess.run(["wl-copy"], input=converted, text=True)

    preview_len = 40
    orig_preview = original.replace("\n", " ")
    conv_preview = converted.replace("\n", " ")
    if len(orig_preview) > preview_len:
        orig_preview = orig_preview[:preview_len] + "…"
    if len(conv_preview) > preview_len:
        conv_preview = conv_preview[:preview_len] + "…"

    subprocess.run([
        "notify-send",
        f"클립보드 {direction} 변환",
        f"원본: {orig_preview}\n변환: {conv_preview}",
    ])

if __name__ == "__main__":
    main()
